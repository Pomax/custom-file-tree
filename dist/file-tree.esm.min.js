var a=n=>document.createElement(n),m=n=>n.includes(".")?!0:(n.substring(n.indexOf("?"))?.split(",")||[]).includes("file"),d=window.customElements;function y(n){return new Promise((t,r)=>{let e=new FileReader;e.onloadend=({target:i})=>t(i.result),e.onerror=r,e.readAsArrayBuffer(n)})}var w=globalThis.HTMLElement??class{},c=class extends w{state={};eventControllers=[];constructor(t=""){super();let r=this.heading=a("entry-heading");this.appendChild(r),this.path=t}addExternalListener(t,r,e,i={}){let s=new AbortController;i.signal=s.signal,t.addEventListener(r,e,i),this.addAbortController(s)}addListener(t,r,e={}){this.addExternalListener(this,t,r,e)}addAbortController(t){if(!t)return console.trace();this.eventControllers.push(t)}disconnectedCallback(){let{eventControllers:t}=this;for(;t.length;)t.shift().abort()}get removeEmpty(){return this.root.getAttribute("remove-empty")}get name(){return this.getAttribute("name")}set name(t){console.log("set name to",t),this.setAttribute("name",t)}get path(){return this.getAttribute("path")}set path(t){!this.isTree&&!t.includes(".")&&!t.endsWith("/")&&(console.warn(`dir path "${t}" does not end in /`),console.trace());let r=t.endsWith("/")?-2:-1;if(this.name=t.split("/").at(r).replace(/#.*/,""),!this.name&&t)throw Error(`why? path is ${t}`);let e=this.find("& > entry-heading");e.textContent=this.name,console.log("set path to",t),this.setAttribute("path",t)}updatePath(t,r){console.log(`replacing ${t} with ${r}`);let e=new RegExp(`^${t}`);console.log(e),this.path=this.path.replace(e,r)}get dirPath(){let{path:t,name:r}=this;if(this.isFile)return t.replace(r,"");if(this.isDir)return t.substring(0,t.lastIndexOf(r));throw Error("entry is file nor dir.")}get root(){return this.closest("file-tree")}get parentDir(){let t=this;return t.tagName==="DIR-ENTRY"&&(t=t.parentNode),t.closest("dir-entry")}emit(t,r={},e=()=>{}){r.grant=()=>{e(),console.log(this.root.entries)},this.root.dispatchEvent(new CustomEvent(t,{detail:r}))}find(t){return this.querySelector(t)}findInTree(t){return this.root.querySelector(t)}findAll(t){return Array.from(this.querySelectorAll(t))}findAllInTree(t){return Array.from(this.root.querySelectorAll(t))}setState(t){Object.assign(this.state,t)}},E=class extends w{};d.define("entry-heading",E);function C(n){let t=new AbortController;n.draggable=!0;let r=()=>{n.findAllInTree(".drop-target").forEach(e=>e.classList.remove("drop-target"))};return n.addEventListener("dragstart",e=>{e.stopPropagation(),n.classList.add("dragging"),n.dataset.id=`${Date.now()}-${Math.random()}`,e.dataTransfer.setData("id",n.dataset.id)},{signal:t.signal}),n.addEventListener("dragenter",e=>{e.preventDefault(),r(),n.classList.add("drop-target")},{signal:t.signal}),n.addEventListener("dragover",e=>{let i=e.target;T(n,i)&&(e.preventDefault(),r(),n.classList.add("drop-target"))},{signal:t.signal}),n.addEventListener("dragleave",e=>{e.preventDefault(),r()},{signal:t.signal}),n.addEventListener("drop",async e=>{e.preventDefault(),e.stopPropagation(),r();let i=e.dataTransfer.getData("id");if(i)return x(n,i);await processUpload(n,e.dataTransfer.items)},{signal:t.signal}),n.path==="."?n.draggable=!1:t}function T(n,t){return t===n?!0:t.closest("dir-entry")===n}function x(n,t){let r=n.findInTree(`[data-id="${t}"]`);if(delete r.dataset.id,r.classList.remove("dragging"),r===n)return;let e=r.path,i=n.path,s=(i!=="."?i:"")+r.name;r.isDir&&(s+="/"),console.log({dirPath:i,name:r.name,newPath:s}),n.root.moveEntry(r,e,s)}function N({root:n}){let t=a("input");t.type="file",t.multiple=!0,confirm('To upload one or more files, press "OK". To upload an entire folder, press "Cancel".')||(t.webkitdirectory=!0),t.addEventListener("change",()=>{let{files:e}=t;e&&L(n,e)}),t.click()}async function L(n,t){async function r(e,i=""){if(e instanceof File){let s=await y(e),o=i+(e.webkitRelativePath||e.name);n.createFile(o,s)}else if(e.isFile)e.file(async s=>{let o=await y(s),l=i+s.name;n.createFile(l,o)});else if(e.isDirectory){let s=i+e.name+"/";e.createReader().readEntries(async o=>{for(let l of o)await r(l,s)})}}for await(let e of t)try{await r(e instanceof File?e:e.webkitGetAsEntry())}catch{return alert(`Unfortunately, a ${e.kind} is not a file or folder.`)}}var h=class extends c{isDir=!0;constructor(t,r=t){super(t,r),this.addButtons()}connectedCallback(){this.clickListener=r=>{if(r.stopPropagation(),r.preventDefault(),this.path===".")return;let e=r.target.tagName;if(e!=="DIR-ENTRY"&&e!=="ENTRY-HEADING")return;let i=this.classList.contains("closed");this.emit("dir:click",{path:this.path,currentState:i?"closed":"open"},()=>this.classList.toggle("closed"))},this.addListener("click",this.clickListener);let t=C(this);t&&this.addAbortController(t)}addButtons(){this.createFileButton(),this.createDirButton(),this.addUploadButton(),this.addRenameButton(),this.addDeleteButton()}createFileButton(){let t=a("button");t.title="Add new file",t.textContent="\u{1F4C4}",t.addEventListener("click",()=>this.#t()),this.appendChild(t)}#t(){let t=prompt("Please specify a filename.")?.trim();if(t){if(t.includes("/"))return alert("Just add new files directly to the directory where they should live.");this.path!=="."&&(t=this.path+t),this.root.createEntry(t)}}createDirButton(){let t=a("button");t.title="Add new directory",t.textContent="\u{1F4C1}",t.addEventListener("click",()=>this.#r()),this.appendChild(t)}#r(){let t=prompt("Please specify a directory name.")?.trim();if(t){if(t.includes("/"))return alert("You'll have to create nested directories one at a time..");let r=(this.path!=="."?this.path:"")+t+"/";this.root.createEntry(r)}}addUploadButton(){let t=a("button");t.title="upload files from your device",t.textContent="\u{1F4BB}",t.addEventListener("click",()=>this.#e()),this.appendChild(t)}#e(){N(this)}addRenameButton(){if(this.path===".")return;let t=a("button");t.title="rename dir",t.textContent="\u270F\uFE0F",this.appendChild(t),t.addEventListener("click",()=>this.#i())}#i(){let t=prompt("Choose a new directory name",this.name)?.trim();if(t){if(t.includes("/"))return alert("If you want to relocate a dir, just move it.");this.root.renameEntry(this,t)}}addDeleteButton(){let t=a("button");t.title="delete dir",t.textContent="\u{1F5D1}\uFE0F",this.appendChild(t),t.addEventListener("click",()=>this.#s())}#s(){confirm("Are you *sure* you want to delete this directory and everything in it?")&&this.root.removeEntry(this.path)}addEntry(t){this.appendChild(t),this.sort()}sort(t=!0){let r=[...this.children];r.sort((e,i)=>e.tagName==="ENTRY-HEADING"?-1:i.tagName==="ENTRY-HEADING"?1:e.tagName==="BUTTON"&&i.tagName==="BUTTON"?0:e.tagName==="BUTTON"?-1:i.tagName==="BUTTON"?1:e.tagName==="DIR-ENTRY"&&i.tagName==="DIR-ENTRY"?(e=e.path,i=i.path,e<i?-1:1):e.tagName==="DIR-ENTRY"?-1:i.tagName==="DIR-ENTRY"?1:(e=e.path,i=i.path,e<i?-1:1)),r.forEach(e=>this.appendChild(e)),t&&this.findAll("& > dir-entry").forEach(e=>e.sort(t))}checkEmpty(){this.removeEmpty&&(this.find("file-entry")||this.emit("dir:delete",{path:this.path},()=>this.remove()))}toJSON(){return JSON.stringify(this.toValue())}toString(){return this.toJSON()}toValue(){return this.root.toValue().filter(t=>t.startsWith(this.path))}};d.define("dir-entry",h);var p=class extends c{isFile=!0;constructor(t,r){super(t,r);let e=a("button");e.title="rename file",e.textContent="\u270F\uFE0F",this.appendChild(e),e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation();let o=prompt("New file name?",this.heading.textContent)?.trim();if(o){if(o.includes("/"))return alert("If you want to relocate a file, just move it.");this.root.renameEntry(this,o)}});let i=a("button");i.title="delete file",i.textContent="\u{1F5D1}\uFE0F",this.appendChild(i),i.addEventListener("click",s=>{if(s.preventDefault(),s.stopPropagation(),confirm("are you sure you want to delete this file?")){let o=this.parentDir;this.emit("file:delete",{path:this.path},()=>{o.removeChild(this),o.checkEmpty()})}}),this.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.root.selected(this)}),this.draggable=!0,this.addEventListener("dragstart",s=>{s.stopPropagation(),this.classList.add("dragging"),this.dataset.id=`${Date.now()}-${Math.random()}`,s.dataTransfer.setData("id",this.dataset.id)})}relocateContent(t,r){this.heading.textContent=this.heading.textContent.replace(t,r),this.path=this.path.replace(t,r)}removeEntry(t){this.path===t&&this.remove()}selectEntry(t){this.classList.toggle("selected",t===this.path)}toJSON(){return JSON.stringify(this.toValue())}toString(){return this.path}toValue(){return[this.toString()]}},v=class extends c{};d.define("file-entry",p);d.define("file-heading",v);var D=class extends c{isTree=!0;entries={};constructor(){super()}get root(){return this}get parentDir(){return this.rootDir}clear(){this.rootDir&&this.removeChild(this.rootDir);let t=this.rootDir=new h(".");this.appendChild(t)}connectedCallback(){this.addExternalListener(document,"dragend",()=>this.findAll(".dragging").forEach(t=>t.classList.remove("dragging")))}setFiles(t=[]){this.clear(),t.forEach(r=>this.#t(r,void 0,"tree:setfiles",!0)),console.log(`
 === setFiles complete ===

`),console.log(this.entries)}createEntry(t,r=void 0){let e=(m(t)?"file":"dir")+":create";this.#t(t,r,e)}#t(t,r=void 0,e,i=!1){let{entries:s}=this;if(s[t])throw new Error(`${t} already exists.`);let o=()=>{console.log(`
--- adding entry ---`);let f=t.split("/").at(-1),u=m(f)?p:h,g=new u(t);s[t]=g,this.#r(g).addEntry(g)};if(i)return o();this.emit(e,{path:t,content:r},o)}#r({dirPath:t}){let{entries:r}=this;if(!t)return this.rootDir;let e=this.find(`[path="${t}"`);return e||(e=this.rootDir,t.split("/").forEach(i=>{if(!i)return;console.log({dirPath:e.path,fragment:i});let s=(e.path==="."?"":e.path)+i+"/",o=this.find(`[path="${s}"`);o||(o=new h(s),e.addEntry(o),r[s]=o),e=o}),e)}renameEntry(t,r){let e=t.path,i=e.lastIndexOf(t.name),s=e.substring(0,i)+r;t.isDir&&(s+="/"),console.log({rename:!0,newName:r,oldPath:e,newPath:s});let o=(t.isFile?"file":"dir")+":rename";this.#e(t,e,s,o)}moveEntry(t,r,e){let i=(t.isFile?"file":"dir")+":move";this.#e(t,r,e,i)}#e(t,r,e,i){let{entries:s}=this;if(s[e])throw new Error(`${e} already exists.`);this.emit(i,{oldPath:r,newPath:e},()=>{console.log("---relocate---"),Object.keys(s).forEach(f=>{if(f.startsWith(r)){let u=s[f];u.updatePath(r,e),s[u.path]=u,delete s[f]}});let{dirPath:o}=s[e]=t;console.log("dirPath for",t,"is",o);let l=o?s[o]:this.rootDir;console.log("adding",t,"to",l),l.addEntry(t)})}removeEntry(t){let{entries:r}=this,e=r[t];if(!e)throw new Error(`${t} does not exist.`);let i=(e.isFile?"file":"dir")+":delete";this.emit(i,{path:t},()=>{let{path:s}=e;Object.entries(r).forEach(([o,l])=>{o.startsWith(s)&&(l.remove(),delete r[o])})})}selectEntry(t){let r=this.entries[t];if(!r)throw new Error(`${t} does not exist.`);r.click()}selected(t){let r=(t.isFile?"file":"dir")+":click";this.emit(r,{path:t.path},()=>{this.find(".selected")?.classList.remove("selected"),t.classList.add("selected")})}sort(){this.rootDir.sort()}toJSON(){return JSON.stringify(Object.keys(this.entries).sort())}toString(){return this.toJSON()}toValue(){return this}};d.define("file-tree",D);
