var d=n=>document.createElement(n);function m(n){return n.split("/").filter(r=>!!r).at(-1).includes(".")?!0:!!C(n).file}function C(n){let t={};return(n.substring(n.indexOf("?"))?.split("&")||[]).forEach(r=>{if(r.includes("=")){let[i,s]=r.split("=");t[i]=s}else t[r]=!0}),t}var f=window.customElements;function g(n){return new Promise((t,e)=>{let r=new FileReader;r.onloadend=({target:i})=>t(i.result),r.onerror=e,r.readAsArrayBuffer(n)})}var L=globalThis.HTMLElement??class{},u=class extends L{state={};eventControllers=[];constructor(t=""){if(super(),t){let e=this.icon=d("span");e.classList.add("icon"),this.appendChild(e);let r=this.heading=d("entry-heading");this.appendChild(r),this.path=t}}addExternalListener(t,e,r,i={}){let s=new AbortController;i.signal=s.signal,t.addEventListener(e,r,i),this.addAbortController(s)}addListener(t,e,r={}){this.addExternalListener(this,t,e,r)}addAbortController(t){this.eventControllers.push(t)}disconnectedCallback(){let{eventControllers:t}=this;for(;t.length;)t.shift().abort()}get removeEmptyDir(){return this.root.getAttribute("remove-empty-dir")}get name(){return this.getAttribute("name")}set name(t){this.setAttribute("name",t)}get path(){return this.getAttribute("path")}set path(t){if(!t)return;let e=t.endsWith("/")?-2:-1;if(this.name=t.split("/").at(e).replace(/#.*/,""),!this.name&&t)throw Error(`why? path is ${t}`);let r=this.find("& > entry-heading");r.textContent=this.name,this.setAttribute("path",t)}updatePath(t,e){let r=new RegExp(`^${t}`);this.path=this.path.replace(r,e)}get dirPath(){let{path:t,name:e}=this;if(this.isFile)return t.replace(e,"");if(this.isDir)return t.substring(0,t.lastIndexOf(e));throw Error("entry is file nor dir.")}get root(){return this.closest("file-tree")}get parentDir(){let t=this;return t.tagName==="DIR-ENTRY"&&(t=t.parentNode),t.closest("dir-entry")}emit(t,e={},r=()=>{}){e.grant=r,this.root.dispatchEvent(new CustomEvent(t,{detail:e}))}find(t){return this.querySelector(t)}findInTree(t){return this.root.querySelector(t)}findAll(t){return Array.from(this.querySelectorAll(t))}findAllInTree(t){return Array.from(this.root.querySelectorAll(t))}select(){this.root.find(".selected")?.classList.remove("selected"),this.classList.add("selected")}setState(t){Object.assign(this.state,t)}},T=class extends L{};f.define("entry-heading",T);var y={"en-GB":{CREATE_FILE:"Create new file",CREATE_FILE_PROMPT:"Please specify a filename.",CREATE_FILE_NO_DIRS:"Just add new files directly to the directory where they should live.",RENAME_FILE:"Rename file",RENAME_FILE_PROMPT:"New file name?",RENAME_FILE_MOVE_INSTEAD:"If you want to relocate a file, just move it.",DELETE_FILE:"Delete file",DELETE_FILE_PROMPT:"Are you sure you want to delete this file?",CREATE_DIRECTORY:"Add new directory",CREATE_DIRECTORY_PROMPT:"Please specify a directory name.",CREATE_DIRECTORY_NO_NESTING:"You'll have to create nested directories one at a time.",RENAME_DIRECTORY:"Rename directory",RENAME_DIRECTORY_PROMPT:"Choose a new directory name",RENAME_DIRECTORY_MOVE_INSTEAD:"If you want to relocate a directory, just move it.",DELETE_DIRECTORY:"Delete directory",DELETE_DIRECTORY_PROMPT:"Are you *sure* you want to delete this directory and everything in it?",UPLOAD_FILES:"Upload files from your device",PATH_EXISTS:n=>`${n} already exists.`,PATH_DOES_NOT_EXIST:n=>`${n} does not exist.`,INVALID_UPLOAD_TYPE:n=>`Unfortunately, a ${n} is not a file or folder.`}},I="en-GB",O=globalThis.navigator?.language,o=y[O]||y[I];function _({root:n,path:t}){let e=d("input");e.type="file",e.multiple=!0,confirm('To upload one or more files, press "OK". To upload an entire folder, press "Cancel".')||(e.webkitdirectory=!0),e.addEventListener("change",()=>{let{files:i}=e;i&&D(n,i,t)}),e.click()}async function D(n,t,e=""){async function r(i,s=""){if(i instanceof File&&!i.isDirectory){let a=await g(i),c=s+(i.webkitRelativePath||i.name),l=(e==="."?"":e)+c;n.createEntry(l,a)}else if(i.isFile)i.file(async a=>{let c=await g(a),l=s+a.name,h=(e==="."?"":e)+l;n.createEntry(h,c)});else if(i.isDirectory){let a=s+i.name+"/";i.createReader().readEntries(async c=>{for(let l of c)await r(l,a)})}}for(let i of t)try{let s;!s&&i instanceof File&&(s=i),!s&&i.webkitGetAsEntry&&(s=i.webkitGetAsEntry()??s),!s&&i.getAsFile&&(s=i.getAsFile()),await r(s)}catch{return alert(o.INVALID_UPLOAD_TYPE(i.kind))}}function A(n){let t=new AbortController;n.draggable=!0;let e=()=>{n.findAllInTree(".drop-target").forEach(r=>r.classList.remove("drop-target"))};return n.addEventListener("dragstart",r=>{r.stopPropagation(),n.classList.add("dragging"),n.dataset.id=`${Date.now()}-${Math.random()}`,r.dataTransfer.setData("id",n.dataset.id)},{signal:t.signal}),n.addEventListener("dragenter",r=>{r.preventDefault(),e(),n.classList.add("drop-target")},{signal:t.signal}),n.addEventListener("dragover",r=>{let i=r.target;v(n,i)&&(r.preventDefault(),e(),n.classList.add("drop-target"))},{signal:t.signal}),n.addEventListener("dragleave",r=>{r.preventDefault(),e()},{signal:t.signal}),n.addEventListener("drop",async r=>{r.preventDefault(),r.stopPropagation(),e();let i=r.dataTransfer.getData("id");if(i)return P(n,i);await D(n.root,r.dataTransfer.items,n.path)},{signal:t.signal}),n.path==="."?n.draggable=!1:t}function v(n,t){return t===n?!0:t.closest("dir-entry")===n}function P(n,t){let e=n.findInTree(`[data-id="${t}"]`);if(delete e.dataset.id,e.classList.remove("dragging"),e===n)return;let r=e.path,i=n.path,s=(i!=="."?i:"")+e.name;e.isDir&&(s+="/"),n.root.moveEntry(e,r,s)}var E=class extends u{isDir=!0;constructor(t,e=t){super(t,e),this.addButtons()}connectedCallback(){this.addListener("click",e=>this.selectListener(e)),this.addExternalListener(this.icon,"click",e=>this.foldListener(e));let t=A(this);t&&this.addAbortController(t)}selectListener(t){if(t.stopPropagation(),t.preventDefault(),this.path===".")return;let e=t.target.tagName;e!=="DIR-ENTRY"&&e!=="ENTRY-HEADING"||this.root.selectEntry(this)}foldListener(t){if(t.stopPropagation(),t.preventDefault(),this.path===".")return;let e=this.classList.contains("closed");this.root.toggleDirectory(this,{currentState:e?"closed":"open"})}addButtons(){this.createFileButton(),this.createDirButton(),this.addUploadButton(),this.addRenameButton(),this.addDeleteButton()}addRenameButton(){if(this.path===".")return;let t=d("button");t.classList.add("rename-dir"),t.title=o.RENAME_DIRECTORY,t.textContent="\u270F\uFE0F",this.appendChild(t),t.addEventListener("click",()=>this.#t())}#t(){let t=prompt(o.RENAME_DIRECTORY_PROMPT,this.name)?.trim();if(t){if(t.includes("/"))return alert(o.RENAME_DIRECTORY_MOVE_INSTEAD);this.root.renameEntry(this,t)}}addDeleteButton(){let t=d("button");t.classList.add("delete-dir"),t.title=o.DELETE_DIRECTORY,t.textContent="\u{1F5D1}\uFE0F",this.appendChild(t),t.addEventListener("click",()=>this.#r())}#r(){let t=o.DELETE_DIRECTORY_PROMPT;confirm(t)&&this.root.removeEntry(this)}createFileButton(){let t=d("button");t.classList.add("create-file"),t.title=o.CREATE_FILE,t.textContent="\u{1F4C4}",t.addEventListener("click",()=>this.#e()),this.appendChild(t)}#e(){let t=prompt(o.CREATE_FILE_PROMPT)?.trim();if(t){if(t.includes("/"))return alert(o.CREATE_FILE_NO_DIRS);this.path!=="."&&(t=this.path+t),this.root.createEntry(t)}}createDirButton(){let t=d("button");t.classList.add("create-dir"),t.title=o.CREATE_DIRECTORY,t.textContent="\u{1F4C1}",t.addEventListener("click",()=>this.#i()),this.appendChild(t)}#i(){let t=prompt(String.CREATE_DIRECTORY_PROMPT)?.trim();if(t){if(t.includes("/"))return alert(o.CREATE_DIRECTORY_NO_NESTING);let e=(this.path!=="."?this.path:"")+t+"/";this.root.createEntry(e)}}addUploadButton(){let t=d("button");t.classList.add("upload"),t.title=o.UPLOAD_FILES,t.textContent="\u{1F4BB}",t.addEventListener("click",()=>_(this)),this.appendChild(t)}addEntry(t){this.appendChild(t),this.sort()}checkEmpty(){if(!this.removeEmptyDir||this.find("dir-entry, file-entry"))return;this.root.removeEntry(this,!0)}sort(t=!0,e=!0){let r=[...this.children];r.sort((i,s)=>{if(i.tagName==="SPAN")return-1;if(s.tagName==="SPAN")return 1;if(i.tagName==="ENTRY-HEADING")return-1;if(s.tagName==="ENTRY-HEADING")return 1;if(i.tagName==="BUTTON"&&s.tagName==="BUTTON")return 0;if(i.tagName==="BUTTON")return-1;if(s.tagName==="BUTTON")return 1;if(e){if(i.tagName==="DIR-ENTRY"&&s.tagName==="DIR-ENTRY")return i=i.path,s=s.path,i<s?-1:1;if(i.tagName==="DIR-ENTRY")return-1;if(s.tagName==="DIR-ENTRY")return 1}return i=i.path,s=s.path,i<s?-1:1}),r.forEach(i=>this.appendChild(i)),t&&this.findAll("& > dir-entry").forEach(i=>i.sort(t))}toggle(){this.classList.toggle("closed")}toJSON(){return JSON.stringify(this.toValue())}toString(){return this.toJSON()}toValue(){return this.root.toValue().filter(t=>t.startsWith(this.path))}};f.define("dir-entry",E);var p=class extends u{isFile=!0;constructor(t,e){super(t,e),this.addRenameButton(),this.addDeleteButton(),this.addEventHandling()}addRenameButton(){let t=d("button");t.classList.add("rename-file"),t.title=o.RENAME_FILE,t.textContent="\u270F\uFE0F",this.appendChild(t),t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();let r=prompt(o.RENAME_FILE_PROMPT,this.heading.textContent)?.trim();if(r){if(r.includes("/"))return alert(o.RENAME_FILE_MOVE_INSTEAD);this.root.renameEntry(this,r)}})}addDeleteButton(){let t=d("button");t.classList.add("delete-file"),t.title=o.DELETE_FILE,t.textContent="\u{1F5D1}\uFE0F",this.appendChild(t),t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),confirm(o.DELETE_FILE_PROMPT)&&this.root.removeEntry(this)})}addEventHandling(){this.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.root.selectEntry(this)}),this.draggable=!0,this.addEventListener("dragstart",t=>{t.stopPropagation(),this.classList.add("dragging"),this.dataset.id=`${Date.now()}-${Math.random()}`,t.dataTransfer.setData("id",this.dataset.id)})}toJSON(){return JSON.stringify(this.toValue())}toString(){return this.path}toValue(){return[this.toString()]}};f.define("file-entry",p);var R=class extends u{isTree=!0;entries={};constructor(){super()}get root(){return this}get parentDir(){return this.rootDir}clear(){this.rootDir&&this.removeChild(this.rootDir);let t=this.rootDir=new E(".");this.appendChild(t)}connectedCallback(){this.addExternalListener(document,"dragend",()=>this.findAll(".dragging").forEach(t=>t.classList.remove("dragging")))}setFiles(t=[]){this.clear(),t.forEach(e=>this.#t(e,void 0,"tree:setfiles",!0))}createEntry(t,e=void 0){let r=(m(t)?"file":"dir")+":create";this.#t(t,e,r)}#t(t,e=void 0,r,i=!1){let{entries:s}=this;if(s[t])throw new Error(o.PATH_EXISTS(t));let a=()=>{let c=m(t)?p:E,l=new c(t);s[t]=l,this.#r(l).addEntry(l)};if(i)return a();this.emit(r,{path:t,content:e},a)}#r({dirPath:t}){let{entries:e}=this;if(!t)return this.rootDir;let r=this.find(`[path="${t}"`);return r||(r=this.rootDir,t.split("/").forEach(i=>{if(!i)return;let s=(r.path==="."?"":r.path)+i+"/",a=this.find(`[path="${s}"`);a||(a=new E(s),r.addEntry(a),e[s]=a),r=a}),r)}renameEntry(t,e){let r=t.path,i=r.lastIndexOf(t.name),s=r.substring(0,i)+e;t.isDir&&(s+="/");let a=(t.isFile?"file":"dir")+":rename";this.#e(t,r,s,a)}moveEntry(t,e,r){let i=(t.isFile?"file":"dir")+":move";this.#e(t,e,r,i)}#e(t,e,r,i){let{entries:s}=this;if(e!==r){if(s[r])throw new Error(o.PATH_EXISTS(r));this.emit(i,{oldPath:e,newPath:r},()=>{Object.keys(s).forEach(l=>{if(l.startsWith(e)){let h=s[l];h.updatePath(e,r),s[h.path]=h,delete s[l]}});let{dirPath:a}=s[r]=t;(a?s[a]:this.rootDir).addEntry(t)})}}removeEntry(t,e=!1){let{entries:r}=this,{path:i,isFile:s,parentDir:a}=t,c=(s?"file":"dir")+":delete",l={path:i};e&&(l.emptyDir=!0),this.emit(c,l,()=>{s||e?(t.remove(),delete r[i]):Object.entries(r).forEach(([h,N])=>{h.startsWith(i)&&(N.remove(),delete r[h])}),a.checkEmpty()})}select(t){let e=this.entries[t];if(!e)throw new Error(o.PATH_DOES_NOT_EXIST(t));e.click()}selectEntry(t,e={}){let r=(t.isFile?"file":"dir")+":click";e.path=t.path,this.emit(r,{detail:e},()=>t.select())}toggleDirectory(t,e={}){let r="dir:toggle";e.path=t.path,this.emit(r,{detail:e},()=>t.toggle())}sort(){this.rootDir.sort()}toJSON(){return JSON.stringify(Object.keys(this.entries).sort())}toString(){return this.toJSON()}toValue(){return this}};f.define("file-tree",R);
