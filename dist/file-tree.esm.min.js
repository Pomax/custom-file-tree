var c=(n,e=document)=>e.querySelector(n),u=(n,e=document)=>Array.from(e.querySelectorAll(n)),l=n=>document.createElement(n),p=globalThis.customElements,w=globalThis.HTMLElement??class{},h=class extends w{get root(){return this.closest("file-tree")}get parentDir(){return this.closest("dir-entry")}};function d(n,e,i={},t=()=>{}){i.grant=t,n.root?.dispatchEvent(new CustomEvent(e,{detail:i}))}var f=class extends h{init(e,i){this.setAttribute("name",e),this.setAttribute("path",i);let t=this.heading=l("file-heading");t.textContent=e,this.appendChild(t);let r=l("button");r.title="rename file",r.textContent="\u270F\uFE0F",this.appendChild(r),r.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation();let o=prompt("New file name?",this.heading.textContent)?.trim();if(o){let C=this.getAttribute("path"),D=C.replace(this.heading.textContent,o),y=this.getAttribute("path");d(this,"filetree:file:rename",{oldName:C,newName:D},()=>{this.setAttribute("path",y.replace(this.heading.textContent,o)),this.setAttribute("name",o),this.heading.textContent=o})}});let s=l("button");s.title="delete file",s.textContent="\u{1F5D1}\uFE0F",this.appendChild(s),s.addEventListener("click",a=>{if(a.preventDefault(),a.stopPropagation(),confirm("are you sure you want to delete this file?")){let o=this.parentDir;d(this,"filetree:file:delete",{path:this.getAttribute("path")},()=>{o.removeChild(this),this.root?.getAttribute("remove-empty")&&o.checkEmpty()})}}),this.addEventListener("click",()=>{d(this,"filetree:file:click",{fullPath:this.getAttribute("path")},()=>{u(".selected",this.root).forEach(a=>a.classList.remove("selected")),this.classList.add("selected")})}),this.draggable=!0,this.addEventListener("dragstart",a=>{a.stopPropagation(),this.classList.add("dragging"),this.dataset.id=`${Date.now()}-${Math.random()}`,a.dataTransfer.setData("id",this.dataset.id)})}relocateContent(e,i){this.heading.textContent=this.heading.textContent.replace(e,i),this.setAttribute("path",this.getAttribute("path").replace(e,i))}removeEntry(e){this.getAttribute("path")===e&&this.remove()}selectEntry(e){this.classList.toggle("selected",e===this.getAttribute("path"))}toJSON(){return`"${this.toValue()}"`}toString(){return this.toValue()}toValue(){return this.getAttribute("path")}},m=class extends h{};p.define("file-entry",f);p.define("file-heading",m);var g=class n extends h{init(e,i=e){this.setNameAndPath(e,i),this.addButtons(e,i)}connectedCallback(){this.removeListener=N(this),this.getAttribute("path")==="."&&(this.draggable=!1)}disconnectedCallback(){this.removeListener()}setNameAndPath(e,i){this.setAttribute("name",e),this.setAttribute("path",i);let t=c("dir-heading",this);(!t||t.parentNode!==this)&&(t=this.heading=l("dir-heading"),this.appendChild(t)),t.textContent=e.replace("/","")}addButtons(e,i){this.addNewEntryButton(e,i),this.addUploadButton(e,i),this.addRenameButton(e,i),this.addDeleteButton(e,i)}addNewEntryButton(e,i){let t=l("button");t.title="add new file",t.textContent="+",t.addEventListener("click",()=>E(this,i)),this.appendChild(t)}addUploadButton(e,i){let t=l("button");t.title="upload files from your device",t.textContent="\u{1F4BB}",t.addEventListener("click",()=>T(this)),this.appendChild(t)}addRenameButton(e,i){if(this.getAttribute("path")!=="."){let t=l("button");t.title="rename dir",t.textContent="\u270F\uFE0F",this.appendChild(t),t.addEventListener("click",()=>F(this))}}addDeleteButton(e,i){let t=l("button");t.title="delete dir",t.textContent="\u{1F5D1}\uFE0F",this.appendChild(t),t.addEventListener("click",()=>k(this))}setFiles(e=[]){for(let i of e)this.addEntry(i,i);this.sort()}addEntry(e,i=e){if(!e.includes("/"))return e.includes(".")?this.addFile(e,i):this.addDirectory(e+"/",i+"/");let t=e.substring(0,e.indexOf("/")+1),r=i.substring(0,i.lastIndexOf("/")+1),s=c(`& > dir-entry[name="${t}"]`,this);return s||(s=new n,s.init(t,r),this.appendChild(s)),s.addEntry(e.replace(t,""),i)}addFile(e,i){let t=c(`& > file-entry[name="${e}"]`,this);return t||(t=new f,t.init(e,i),this.appendChild(t),this.sort(!1)),t}addFileFromUpload(e,i){let t=this.getAttribute("path"),r=(t!=="."?t:"")+e;d(this,"filetree:file:upload",{fileName:r,content:i},()=>{this.addEntry(e,r),this.sort()})}addDirectory(e,i){let t=new n;return t.init(e,i),this.appendChild(t),this.sort(!1),t}sort(e=!0){let i=[...this.children];i.sort((t,r)=>t.tagName==="DIR-HEADING"?-1:r.tagName==="DIR-HEADING"?1:t.tagName==="BUTTON"?-1:r.tagName==="BUTTON"?1:t.tagName==="DIR-ENTRY"&&r.tagName==="DIR-ENTRY"?(t=t.getAttribute("path"),r=r.getAttribute("path"),t<r?-1:1):t.tagName==="DIR-ENTRY"?-1:r.tagName==="DIR-ENTRY"?1:(t=t.getAttribute("path"),r=r.getAttribute("path"),t<r?-1:1)),i.forEach(t=>this.appendChild(t)),e&&u("dir-entry",this).forEach(t=>t.sort(e))}relocateContent(e,i){for(let t of this.children)t.relocateContent?.(e,i)}removeEntry(e){for(let i of this.children)i.removeEntry?.(e)}selectEntry(e){for(let i of this.children)i.selectEntry?.(e)}checkEmpty(){this.root.getAttribute("remove-empty")&&(c("file-entry",this)||d(this,"filetree:dir:delete",{path:this.getAttribute("path")},()=>{this.parentNode.removeChild(this)}))}toJSON(){return JSON.stringify(this.toValue())}toString(){return this.toValue().join(",")}toValue(){return[u("& > dir-entry",this).map(e=>e.toValue()),u("& > file-entry",this).map(e=>e.toValue())].flat(1/0)}},b=class extends h{};p.define("dir-entry",g);p.define("dir-heading",b);function x(n){return new Promise((e,i)=>{let t=new FileReader;t.onloadend=({target:r})=>e(r.result),t.onerror=i,t.readAsText(n)})}function L(n,e){return e===n?!0:e.parentDir===n}function N(n){let e=new AbortController;return n.draggable=!0,n.addEventListener("dragstart",i=>{i.stopPropagation(),n.classList.add("dragging"),n.dataset.id=`${Date.now()}-${Math.random()}`,i.dataTransfer.setData("id",n.dataset.id)},{signal:e.signal}),n.addEventListener("dragenter",i=>{i.preventDefault(),n.classList.add("drop")},{signal:e.signal}),n.addEventListener("dragover",i=>{let t=i.target;L(n,t)&&(i.preventDefault(),n.classList.add("drop"))},{signal:e.signal}),n.addEventListener("dragleave",i=>{i.preventDefault(),n.classList.remove("drop")},{signal:e.signal}),n.addEventListener("drop",async i=>{i.preventDefault(),i.stopPropagation(),n.classList.remove("drop");let t=i.dataTransfer.getData("id");if(t)return P(n,t);await v(n,i.dataTransfer.items)},{signal:e.signal}),()=>e.abort()}function E(n,e){let i=prompt(`Please specify a filename.
Use / as directory delimiter (e.g. cake/yum.js)`)?.trim();if(i){let t=i;e!=="."&&(i=e+i),i.includes(".")?d(n,"filetree:file:create",{fileName:i},()=>n.addEntry(t,i)):confirm(`Did you mean to create a new directory ${i}?`)&&d(n,"filetree:dir:create",{dirName:i},()=>{n.addDirectory(t+"/",i+"/")})}}function T(n){let e=l("input");e.type="file",e.multiple=!0,confirm('To upload one or more files, press "OK". To upload an entire folder, press "Cancel".')||(e.webkitdirectory=!0),e.addEventListener("change",()=>{let{files:t}=e;t&&(console.log(t),v(n,t))}),e.click()}async function v(n,e){console.log(e);async function i(t,r=""){if(t instanceof File){let s=await x(t),a=r+(t.webkitRelativePath||t.name);n.addFileFromUpload(a,s)}else t.isFile?t.file(async s=>{let a=await x(s),o=r+s.name;n.addFileFromUpload(o,a)}):t.isDirectory&&t.createReader().readEntries(async s=>{for(let a of s)await i(a,r+t.name+"/")})}await Promise.all([...e].map(async t=>await i(t instanceof File?t:t.webkitGetAsEntry())))}function F(n){let e=prompt("Choose a new directory name",n.heading.textContent)?.trim();if(e){let i=n.heading.textContent,t=n.getAttribute("path"),r=t.replace(i,e);d(n,"filetree:dir:rename",{oldPath:t,newPath:r},()=>{let s=n.getAttribute("path");return n.heading.textContent=e,n.setAttribute("name",e),n.setAttribute("path",r),n.relocateContent(s,r),{oldPath:s,newPath:r}})}}function k(n){confirm("Are you *sure* you want to delete this directory and everything in it?")&&d(n,"filetree:dir:delete",{path:n.getAttribute("path")},()=>{n.remove()})}function P(n,e){let i=c(`[data-id="${e}"]`);delete i.dataset.id,i.classList.remove("dragging");let t=i.getAttribute("path"),r=n.getAttribute("path");if(i instanceof f){let s=(r!=="."?r:"")+t.substring(t.lastIndexOf("/")+1);if(t!==s){if(c(`[path="${s}"]`,n.root))return alert(`File ${s} already exists.`);d(n,"filetree:file:move",{oldPath:t,newPath:s},()=>{i.setAttribute("path",s),n.appendChild(i),n.sort()})}}if(i instanceof g){let s=(r!=="."?r:"")+i.heading.textContent+"/";if(t!==s){if(c(`[path="${s}"]`,n.root))return alert(`Dir ${s} already exists.`);d(n,"filetree:dir:move",{oldPath:t,newPath:s},()=>(u("[path]",i).forEach(o=>{o.setAttribute("path",o.getAttribute("path").replace(t,s))}),i.setAttribute("path",i.getAttribute("path").replace(t,s)),n.appendChild(i),n.sort(),{oldPath:t,newPath:s}))}}}var A=class extends h{setFiles(e=[]){let i=this.querySelector('dir-tree[path="."]');i||(i=this.rootDir=new g,i.init("."),this.appendChild(i)),i.setFiles(e)}addEntry(e){this.rootDir.addEntry(e)}removeEntry(e){this.rootDir.removeEntry(e)}selectEntry(e){this.rootDir.selectEntry(e)}toJSON(){return this.rootDir.toJSON()}toString(){return this.rootDir.toString()}toValue(){return this.toString()}};p.define("file-tree",A);
