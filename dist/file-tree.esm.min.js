var d=s=>document.createElement(s);function m(s){return s.split("/").filter(r=>!!r).at(-1).includes(".")?!0:!!A(s).file}function A(s){let t={};return(s.substring(s.indexOf("?"))?.split("&")||[]).forEach(r=>{if(r.includes("=")){let[i,n]=r.split("=");t[i]=n}else t[r]=!0}),t}var h=window.customElements;function g(s){return new Promise((t,e)=>{let r=new FileReader;r.onloadend=({target:i})=>t(i.result),r.onerror=e,r.readAsArrayBuffer(s)})}var L=globalThis.HTMLElement??class{},u=class extends L{state={};eventControllers=[];constructor(t=""){super();let e=this.heading=d("entry-heading");this.appendChild(e),this.path=t}addExternalListener(t,e,r,i={}){let n=new AbortController;i.signal=n.signal,t.addEventListener(e,r,i),this.addAbortController(n)}addListener(t,e,r={}){this.addExternalListener(this,t,e,r)}addAbortController(t){this.eventControllers.push(t)}disconnectedCallback(){let{eventControllers:t}=this;for(;t.length;)t.shift().abort()}get removeEmptyDir(){return this.root.getAttribute("remove-empty-dir")}get name(){return this.getAttribute("name")}set name(t){this.setAttribute("name",t)}get path(){return this.getAttribute("path")}set path(t){if(!t)return;let e=t.endsWith("/")?-2:-1;if(this.name=t.split("/").at(e).replace(/#.*/,""),!this.name&&t)throw Error(`why? path is ${t}`);let r=this.find("& > entry-heading");r.textContent=this.name,this.setAttribute("path",t)}updatePath(t,e){let r=new RegExp(`^${t}`);this.path=this.path.replace(r,e)}get dirPath(){let{path:t,name:e}=this;if(this.isFile)return t.replace(e,"");if(this.isDir)return t.substring(0,t.lastIndexOf(e));throw Error("entry is file nor dir.")}get root(){return this.closest("file-tree")}get parentDir(){let t=this;return t.tagName==="DIR-ENTRY"&&(t=t.parentNode),t.closest("dir-entry")}emit(t,e={},r=()=>{}){e.grant=()=>{r()},this.root.dispatchEvent(new CustomEvent(t,{detail:e}))}find(t){return this.querySelector(t)}findInTree(t){return this.root.querySelector(t)}findAll(t){return Array.from(this.querySelectorAll(t))}findAllInTree(t){return Array.from(this.root.querySelectorAll(t))}setState(t){Object.assign(this.state,t)}},T=class extends L{};h.define("entry-heading",T);function _({root:s,path:t}){let e=d("input");e.type="file",e.multiple=!0,confirm('To upload one or more files, press "OK". To upload an entire folder, press "Cancel".')||(e.webkitdirectory=!0),e.addEventListener("change",()=>{let{files:i}=e;i&&D(s,i,t)}),e.click()}async function D(s,t,e=""){async function r(i,n=""){if(i instanceof File){let a=await g(i),c=n+(i.webkitRelativePath||i.name);s.createEntry(e+c,a)}else if(i.isFile)i.file(async a=>{let c=await g(a),l=n+a.name;s.createEntry(e+l,c)});else if(i.isDirectory){let a=n+i.name+"/";i.createReader().readEntries(async c=>{for(let l of c)await r(l,a)})}}for await(let i of t)try{await r(i instanceof File?i:i.webkitGetAsEntry())}catch{return alert(`Unfortunately, a ${i.kind} is not a file or folder.`)}}function y(s){let t=new AbortController;s.draggable=!0;let e=()=>{s.findAllInTree(".drop-target").forEach(r=>r.classList.remove("drop-target"))};return s.addEventListener("dragstart",r=>{r.stopPropagation(),s.classList.add("dragging"),s.dataset.id=`${Date.now()}-${Math.random()}`,r.dataTransfer.setData("id",s.dataset.id)},{signal:t.signal}),s.addEventListener("dragenter",r=>{r.preventDefault(),e(),s.classList.add("drop-target")},{signal:t.signal}),s.addEventListener("dragover",r=>{let i=r.target;I(s,i)&&(r.preventDefault(),e(),s.classList.add("drop-target"))},{signal:t.signal}),s.addEventListener("dragleave",r=>{r.preventDefault(),e()},{signal:t.signal}),s.addEventListener("drop",async r=>{r.preventDefault(),r.stopPropagation(),e();let i=r.dataTransfer.getData("id");if(i)return O(s,i);await D(s.root,r.dataTransfer.items,s.path)},{signal:t.signal}),s.path==="."?s.draggable=!1:t}function I(s,t){return t===s?!0:t.closest("dir-entry")===s}function O(s,t){let e=s.findInTree(`[data-id="${t}"]`);if(delete e.dataset.id,e.classList.remove("dragging"),e===s)return;let r=e.path,i=s.path,n=(i!=="."?i:"")+e.name;e.isDir&&(n+="/"),s.root.moveEntry(e,r,n)}var C={"en-GB":{CREATE_FILE:"Create new file",CREATE_FILE_PROMPT:"Please specify a filename.",CREATE_FILE_NO_DIRS:"Just add new files directly to the directory where they should live.",RENAME_FILE:"Rename file",RENAME_FILE_PROMPT:"New file name?",RENAME_FILE_MOVE_INSTEAD:"If you want to relocate a file, just move it.",DELETE_FILE:"Delete file",DELETE_FILE_PROMPT:"Are you sure you want to delete this file?",CREATE_DIRECTORY:"Add new directory",CREATE_DIRECTORY_PROMPT:"Please specify a directory name.",CREATE_DIRECTORY_NO_NESTING:"You'll have to create nested directories one at a time.",RENAME_DIRECTORY:"Rename directory",RENAME_DIRECTORY_PROMPT:"Choose a new directory name",RENAME_DIRECTORY_MOVE_INSTEAD:"If you want to relocate a directory, just move it.",DELETE_DIRECTORY:"Delete directory",DELETE_DIRECTORY_PROMPT:"Are you *sure* you want to delete this directory and everything in it?",UPLOAD_FILES:"Upload files from your device",PATH_EXISTS:s=>`${s} already exists.`,PATH_DOES_NOT_EXIST:s=>`${s} does not exist.`}},v="en-GB",P=globalThis.navigator?.language,o=C[P]||C[v];var f=class extends u{isDir=!0;constructor(t,e=t){super(t,e),this.addButtons()}connectedCallback(){this.clickListener=e=>{if(e.stopPropagation(),e.preventDefault(),this.path===".")return;let r=e.target.tagName;if(r!=="DIR-ENTRY"&&r!=="ENTRY-HEADING")return;let i=this.classList.contains("closed");this.root.selectEntry(this,{currentState:i?"closed":"open"})},this.addListener("click",this.clickListener);let t=y(this);t&&this.addAbortController(t)}addButtons(){this.addRenameButton(),this.addDeleteButton(),this.createFileButton(),this.createDirButton(),this.addUploadButton()}addRenameButton(){if(this.path===".")return;let t=d("button");t.classList.add("rename-dir"),t.title=o.RENAME_DIRECTORY,t.textContent="\u270F\uFE0F",this.appendChild(t),t.addEventListener("click",()=>this.#t())}#t(){let t=prompt(o.RENAME_DIRECTORY_PROMPT,this.name)?.trim();if(t){if(t.includes("/"))return alert(o.RENAME_DIRECTORY_MOVE_INSTEAD);this.root.renameEntry(this,t)}}addDeleteButton(){let t=d("button");t.classList.add("delete-dir"),t.title=o.DELETE_DIRECTORY,t.textContent="\u{1F5D1}\uFE0F",this.appendChild(t),t.addEventListener("click",()=>this.#r())}#r(){let t=o.DELETE_DIRECTORY_PROMPT;confirm(t)&&this.root.removeEntry(this)}createFileButton(){let t=d("button");t.classList.add("add-file"),t.title=o.CREATE_FILE,t.textContent="\u{1F4C4}",t.addEventListener("click",()=>this.#e()),this.appendChild(t)}#e(){let t=prompt(o.CREATE_FILE_PROMPT)?.trim();if(t){if(t.includes("/"))return alert(o.CREATE_FILE_NO_DIRS);this.path!=="."&&(t=this.path+t),this.root.createEntry(t)}}createDirButton(){let t=d("button");t.classList.add("add-dir"),t.title=o.CREATE_DIRECTORY,t.textContent="\u{1F4C1}",t.addEventListener("click",()=>this.#i()),this.appendChild(t)}#i(){let t=prompt(String.CREATE_DIRECTORY_PROMPT)?.trim();if(t){if(t.includes("/"))return alert(o.CREATE_DIRECTORY_NO_NESTING);let e=(this.path!=="."?this.path:"")+t+"/";this.root.createEntry(e)}}addUploadButton(){let t=d("button");t.classList.add("upload"),t.title=o.UPLOAD_FILES,t.textContent="\u{1F4BB}",t.addEventListener("click",()=>_(this)),this.appendChild(t)}addEntry(t){this.appendChild(t),this.sort()}checkEmpty(){if(!this.removeEmptyDir||this.find("dir-entry, file-entry"))return;this.root.removeEntry(this,!0)}sort(t=!0,e=!0){let r=[...this.children];r.sort((i,n)=>{if(i.tagName==="ENTRY-HEADING")return-1;if(n.tagName==="ENTRY-HEADING")return 1;if(i.tagName==="BUTTON"&&n.tagName==="BUTTON")return 0;if(i.tagName==="BUTTON")return-1;if(n.tagName==="BUTTON")return 1;if(e){if(i.tagName==="DIR-ENTRY"&&n.tagName==="DIR-ENTRY")return i=i.path,n=n.path,i<n?-1:1;if(i.tagName==="DIR-ENTRY")return-1;if(n.tagName==="DIR-ENTRY")return 1}return i=i.path,n=n.path,i<n?-1:1}),r.forEach(i=>this.appendChild(i)),t&&this.findAll("& > dir-entry").forEach(i=>i.sort(t))}select(){this.classList.toggle("closed")}toJSON(){return JSON.stringify(this.toValue())}toString(){return this.toJSON()}toValue(){return this.root.toValue().filter(t=>t.startsWith(this.path))}};h.define("dir-entry",f);var p=class extends u{isFile=!0;constructor(t,e){super(t,e),this.addRenameButton(),this.addDeleteButton(),this.addEventHandling()}addRenameButton(){let t=d("button");t.classList.add("rename-file"),t.title=o.RENAME_FILE,t.textContent="\u270F\uFE0F",this.appendChild(t),t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();let r=prompt(o.RENAME_FILE_PROMPT,this.heading.textContent)?.trim();if(r){if(r.includes("/"))return alert(o.RENAME_FILE_MOVE_INSTEAD);this.root.renameEntry(this,r)}})}addDeleteButton(){let t=d("button");t.classList.add("delete-file"),t.title=o.DELETE_FILE,t.textContent="\u{1F5D1}\uFE0F",this.appendChild(t),t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),confirm(o.DELETE_FILE_PROMPT)&&this.root.removeEntry(this)})}addEventHandling(){this.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.root.selectEntry(this)}),this.draggable=!0,this.addEventListener("dragstart",t=>{t.stopPropagation(),this.classList.add("dragging"),this.dataset.id=`${Date.now()}-${Math.random()}`,t.dataTransfer.setData("id",this.dataset.id)})}select(){this.root.find(".selected")?.classList.remove("selected"),this.classList.add("selected")}toJSON(){return JSON.stringify(this.toValue())}toString(){return this.path}toValue(){return[this.toString()]}};h.define("file-entry",p);var R=class extends u{isTree=!0;entries={};constructor(){super()}get root(){return this}get parentDir(){return this.rootDir}clear(){this.rootDir&&this.removeChild(this.rootDir);let t=this.rootDir=new f(".");this.appendChild(t)}connectedCallback(){this.addExternalListener(document,"dragend",()=>this.findAll(".dragging").forEach(t=>t.classList.remove("dragging")))}setFiles(t=[]){this.clear(),t.forEach(e=>this.#t(e,void 0,"tree:setfiles",!0))}createEntry(t,e=void 0){let r=(m(t)?"file":"dir")+":create";this.#t(t,e,r)}#t(t,e=void 0,r,i=!1){let{entries:n}=this;if(n[t])throw new Error(o.PATH_EXISTS(t));let a=()=>{let c=m(t)?p:f,l=new c(t);n[t]=l,this.#r(l).addEntry(l)};if(i)return a();this.emit(r,{path:t,content:e},a)}#r({dirPath:t}){let{entries:e}=this;if(!t)return this.rootDir;let r=this.find(`[path="${t}"`);return r||(r=this.rootDir,t.split("/").forEach(i=>{if(!i)return;let n=(r.path==="."?"":r.path)+i+"/",a=this.find(`[path="${n}"`);a||(a=new f(n),r.addEntry(a),e[n]=a),r=a}),r)}renameEntry(t,e){let r=t.path,i=r.lastIndexOf(t.name),n=r.substring(0,i)+e;t.isDir&&(n+="/");let a=(t.isFile?"file":"dir")+":rename";this.#e(t,r,n,a)}moveEntry(t,e,r){let i=(t.isFile?"file":"dir")+":move";this.#e(t,e,r,i)}#e(t,e,r,i){let{entries:n}=this;if(e!==r){if(n[r])throw new Error(o.PATH_EXISTS(r));this.emit(i,{oldPath:e,newPath:r},()=>{Object.keys(n).forEach(l=>{if(l.startsWith(e)){let E=n[l];E.updatePath(e,r),n[E.path]=E,delete n[l]}});let{dirPath:a}=n[r]=t;(a?n[a]:this.rootDir).addEntry(t)})}}removeEntry(t,e=!1){let{entries:r}=this,{path:i,isFile:n,parentDir:a}=t,c=(n?"file":"dir")+":delete",l={path:i};e&&(l.emptyDir=!0),this.emit(c,l,()=>{n||e?(t.remove(),delete r[i]):Object.entries(r).forEach(([E,N])=>{E.startsWith(i)&&(N.remove(),delete r[E])}),a.checkEmpty()})}select(t){let e=this.entries[t];if(!e)throw new Error(o.PATH_DOES_NOT_EXIST(t));e.click()}selectEntry(t,e={}){let r=(t.isFile?"file":"dir")+":click";e.path=t.path,this.emit(r,{detail:e},()=>t.select())}sort(){this.rootDir.sort()}toJSON(){return JSON.stringify(Object.keys(this.entries).sort())}toString(){return this.toJSON()}toValue(){return this}};h.define("file-tree",R);
